# Pikocore Firmware Architecture

## Overview

Pikocore is a lo-fi music mangler firmware for Raspberry Pi Pico that manipulates audio samples in real-time based on user input and clock synchronization. The architecture consists of a high-priority audio interrupt handler for sample-accurate playback and a main control loop for user interface and parameter management.

## Entry Point

**[main.cpp](main.cpp)** - Main firmware entry at `main()` (line 969)

## Core Architecture

### 1. Dual-Loop Design

#### Audio Thread (High Priority - PWM Interrupt)
- **Handler**: `pwm_interrupt_handler()` 
- **Rate**: SAMPLE_RATE (default 31kHz)
- **Responsibilities**:
  - Generate audio samples from flash-stored audio data
  - Apply real-time audio effects (filter, distortion, volume)
  - Beat/clock counting and synchronization
  - Button state detection for beat selection
  - Phase management for crossfading between playback heads
  - Retriggering logic for rhythmic effects

#### Control Loop (Low Priority - Main Loop)
- **Rate**: ~20Hz (MAIN_LOOP_HZ=4, MAIN_LOOP_DELAY=50μs)
- **Responsibilities**:
  - USB MIDI communication (`tud_task()`)
  - Read knobs and buttons
  - Update LED array feedback
  - Process clock/MIDI input for BPM sync
  - Flash persistence (save/load settings)
  - WS2812 RGB LED control (optional)

### 2. Input Components

| Component | Class | GPIO | Description |
|-----------|-------|------|-------------|
| Buttons | `Button` | 4-11 | 8 buttons for beat/step selection |
| Knobs | `Knob` | ADC 26-28 | 3 analog inputs (Menu, Function A, Function B) |
| Clock In | - | 22 | External clock synchronization |
| MIDI In | `Onewiremidi` | 22 | Optional one-wire MIDI input (PIO-based) |

**Knob Functions** (selector-based):
- **Knob 0 (Menu)**: Select control
- **Knob 1/2** (swappable based on PCB version): 
  - Function A: BPM, noise gate, jump probability, tunnel probability, record mode, save
  - Function B: Break effects, stretch, gate/retrig/reverse probabilities, playback mode, load

### 3. Audio Processing Pipeline

```
Flash Memory (audio2h.h: raw_audio[])
        ↓
Phase Management (dual playback heads with crossfading)
        ↓
Sample Retrieval (forward/reverse, beat-locked)
        ↓
Volume Modification (volume_reduce, distortion)
        ↓
Low-Pass Filter (biquad IIR, filter.h)
        ↓
PWM Output (GPIO 20, 8-bit @ 31kHz)
```

#### Key Audio Features:
- **Dual-head playback**: Crossfading between two playback positions for glitch-free beat jumping
- **Beat-locked samples**: Audio organized as beats (eighth-notes)
- **Probabilistic effects**: Jump, retrig, gate, direction change, tunnel (sample switching)
- **Distortion**: Wave-folding style distortion
- **Filtering**: IIR biquad low-pass filter with 46 cutoff positions
- **Noise gate**: Automatic fade-out after configurable threshold

### 4. Output Components

| Component | Class | GPIO | Description |
|-----------|-------|------|-------------|
| Audio Out | PWM | 20 | 8-bit audio via PWM |
| LED Array | `LEDArray` | 12-19 | 8 LEDs for beat visualization |
| Trigger Out | `TriggerOut` | 21 | Beat-sync trigger signal |
| MIDI Out | `MidiOut` | USB | USB MIDI output |
| RGB LED | `WS2812` | 23 | Optional status LED (WS2812) |
| Onboard LED | - | 25 | Beat indicator |

### 5. Core Data Structures

#### Sample Management
- **Storage**: `audio2h.h` - Flash-resident audio samples (8-bit, generated by `audio2h/` tool)
- **Organization**: Beats (eighth-notes) at BPM_SAMPLED (165 BPM default)
- **Access**: `raw_val(sample, phase)` and `raw_len(sample)` functions

#### Beat/Sequencing
- **Sequencer**: `Sequencer` class - Records and plays back button press patterns
- **Beat tracking**: `beat_counter`, `beat_thresh` - Tracks current position in beat grid
- **Phase management**: `phase_sample[2]` - Dual playback heads for crossfading
- **Retriggering**: Rhythmic subdivision effects with predefined patterns (`retrigs[]`)

#### State Persistence
- **Flash storage**: 256-byte page at `FLASH_TARGET_OFFSET2`
- **Saved parameters**: Volume, BPM, filter, sample, gate, probabilities, sequencer data
- **Save triggers**: Knob position > threshold for save/load

### 6. Clock Synchronization

Two modes of operation:

1. **Internal Clock**: BPM set via knob (50-360 BPM in 5 BPM increments)
2. **External Clock**: 
   - Via clock input pin (PO-style clock, calibrated)
   - Via MIDI clock (24 PPQN, optional with `MIDI_IN_ENABLED=1`)

Clock sync uses running average filter and calibration formula for stable BPM tracking.

### 7. Key Algorithms

#### Crossfading (Beat Jumping)
- Uses dual playback heads with linear crossfade
- Crossfade duration: `1 << HEAD_SHIFT` samples (1024 samples = ~33ms)
- Enables glitch-free transitions when changing beats

#### Button Logic
- Single button: Select specific beat
- Two buttons: Trigger retrig effect between two beats
- Button state tracked in PWM interrupt for sample-accurate timing

#### Probabilistic Behavior
- Each beat can randomly trigger: direction change, jump, retrig, gate, tunnel
- Probabilities derived from easing curves (`doth/easings/`)
- Evaluated at beat boundaries

## Data Flow

```
┌─────────────────────────────────────────────────────────────┐
│                     HARDWARE INPUTS                          │
│  Buttons(8) | Knobs(3) | Clock In | MIDI In(opt) | USB      │
└────┬─────────────┬───────────┬───────────┬──────────┬────────┘
     │             │           │           │          │
     │    ┌────────▼───────────▼───────────▼──────┐   │
     │    │      Control Loop (~20Hz)              │   │
     │    │  - Read inputs                         │   │
     │    │  - Update parameters                   │◄──┘
     │    │  - Clock sync                          │
     │    │  - Flash save/load                     │
     │    │  - LED updates                         │
     │    └────────┬───────────────────────────────┘
     │             │ (Parameter updates)
     │             ▼
     └────────►┌───────────────────────────────────┐
               │  PWM Interrupt Handler (31kHz)    │
               │  - Beat counting                  │
               │  - Button state check             │
               │  - Sample selection               │
               │  - Audio processing               │
               │  - Effect application             │
               └───────────┬───────────────────────┘
                           │
                           ▼
               ┌───────────────────────────────────┐
               │         HARDWARE OUTPUTS          │
               │ Audio | LEDs | Trigger | MIDI Out │
               └───────────────────────────────────┘
```

## Build System

- **CMake**: Main build configuration
- **Pico SDK**: Raspberry Pi Pico C/C++ SDK
- **Audio prep**: Go-based tool (`audio2h/`) converts FLAC/WAV to C header
- **Sample rate**: Configurable via `SAMPLE_RATE` environment variable
- **Flash size**: Separate targets for 2MB (`build2`) and 16MB (`build16`)

## Key Files

| File | Purpose |
|------|---------|
| [main.cpp](main.cpp) | Main firmware, interrupt handlers, control loop |
| [doth/audio2h.h](doth/audio2h.h) | Generated audio sample data |
| [doth/filter.h](doth/filter.h) | IIR biquad filter coefficients and implementation |
| [doth/button.h](doth/button.h) | Button debouncing and state management |
| [doth/knob.h](doth/knob.h) | ADC reading and smoothing |
| [doth/sequencer.h](doth/sequencer.h) | Pattern recording and playback |
| [doth/ledarray.h](doth/ledarray.h) | LED array control |
| [doth/midi_out.h](doth/midi_out.h) | USB MIDI output |
| [doth/onewiremidi.h](doth/onewiremidi.h) | PIO-based MIDI input |
| [doth/WS2812.hpp](doth/WS2812.hpp) | RGB LED control (optional) |
| [doth/easing.h](doth/easing.h) | Lookup tables for parameter curves |

## Configuration

Compile-time options in [target_compile_definitions.cmake](target_compile_definitions.cmake):
- `WS2812_ENABLED`: Enable/disable RGB LED
- `MIDI_IN_ENABLED`: Enable/disable MIDI input (requires hardware mod)
- `PCB_V2_LAYOUT`: Swap knob assignments for V2 PCB
- `DEBUG_*`: Various debug output flags

## Performance Characteristics

- **CPU Clock**: CLOCK_RATE = SAMPLE_RATE × 8 (default 248 MHz)
- **Audio latency**: ~32μs (single sample period)
- **Button latency**: Sample-accurate (checked in interrupt)
- **Control latency**: ~50ms (control loop period)
- **Memory**: ~180KB flash for typical audio sample, 256 bytes flash for settings
